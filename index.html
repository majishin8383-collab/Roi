<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ROI Scanner â€” Radar</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 16px;
      background: #0b0c10;
      color: #eef2ff;
    }
    h1 { font-size: 18px; margin-bottom: 6px; }
    .note { font-size: 12px; color: #9aa4b2; margin-bottom: 12px; }

    button {
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      background: #4f46e5;
      color: white;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .card {
      background: #171a22;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #2a2f3b;
    }

    .title { font-weight: 700; font-size: 14px; margin-bottom: 6px; }
    .meta { font-size: 12px; color: #9aa4b2; margin-bottom: 6px; }
    .chips { display: flex; gap: 6px; flex-wrap: wrap; }

    .chip {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #222636;
    }

    .good { color: #22c55e; }
    .bad { color: #ef4444; }

    a {
      color: #c7d2fe;
      font-size: 13px;
      text-decoration: none;
    }

    #status {
      font-size: 13px;
      color: #9aa4b2;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <h1>ROI Scanner â€” Radar</h1>
  <div class="note">Build 4: async comps via Cloudflare Worker</div>

  <button id="run">Run Radar</button>
  <div id="status">Idle</div>

  <div id="grid"></div>

  <script type="module">
    const grid = document.getElementById("grid");
    const status = document.getElementById("status");
    const runBtn = document.getElementById("run");

    const CACHE_BUSTER = Date.now();
    let demoRunRadar = null;

    function money(n) {
      const v = Number(n);
      return v < 0 ? `-$${Math.abs(v).toFixed(2)}` : `$${v.toFixed(2)}`;
    }

    function render(deals) {
      grid.innerHTML = "";
      for (const d of deals) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="title">${d.listing.title}</div>
          <div class="meta">${d.dealType}</div>
          <div class="chips">
            <span class="chip ${d.netProfit >= 0 ? "good" : "bad"}">
              Profit ${money(d.netProfit)}
            </span>
            <span class="chip">ROI ${Math.round(d.roi * 100)}%</span>
            <span class="chip">Conf ${d.confidence}</span>
          </div>
          <div style="margin-top:6px">
            <a href="${d.listing.url}" target="_blank">Open Listing</a>
          </div>
        `;
        grid.appendChild(card);
      }
    }

    // Load async radar
    try {
      const mod = await import(`./js/app/testRadar.js?v=${CACHE_BUSTER}`);
      demoRunRadar = mod.demoRunRadar;
    } catch (err) {
      status.textContent = "Failed to load radar module.";
      console.error(err);
    }

    runBtn.addEventListener("click", async () => {
      if (!demoRunRadar) return;

      status.textContent = "Fetching sold compsâ€¦ first run may take ~10â€“15s";
      grid.innerHTML = "";

      try {
        const deals = await demoRunRadar();   // ðŸ”‘ THE FIX
        render(deals);
        status.textContent = `Done â€” ${deals.length} deals`;
      } catch (err) {
        status.textContent = "Radar error â€” see console";
        console.error(err);
      }
    });
  </script>
</body>
</html>
